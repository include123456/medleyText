{"_id":"SyvlYySfG","title":"多线程","body":{"entityMap":{},"blocks":[{"key":"ag6qs","text":"多线程","type":"header-one","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"di40s","text":"","type":"unstyled","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"i9na","text":"package com.sinovatech.reportServer;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"5v62j","text":"","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"9dn","text":"import java.util.List;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"6t88o","text":"import java.util.concurrent.ExecutorService;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"3ahg2","text":"import java.util.concurrent.Executors;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"9349p","text":"","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"c1vrs","text":"import org.apache.commons.lang.StringUtils;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"6kef4","text":"import org.apache.commons.logging.Log;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"ek69p","text":"import org.apache.commons.logging.LogFactory;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"32ruq","text":"","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"9ihv8","text":"import com.sinovatech.common.util.IPRequest;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"cq7e3","text":"import com.sinovatech.reportServer.bean.ExportQueueBean;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"82jco","text":"import com.sinovatech.reportServer.service.ReportService;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"875mm","text":"","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"31cci","text":"public class ExportCrontab {","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"53lp9","text":"","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"47gle","text":"\tprivate static Log log = LogFactory.getLog(ExportCrontab.class);","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"8s6el","text":"\tprivate ExecutorService exec;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"bg0oh","text":"\tprivate int coreCpuNum;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"dcns6","text":"\tprivate ReportService reportService = new ReportService();","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"783j0","text":"\tprivate static final String serverIp = IPRequest.getIpAddress();","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"7m3to","text":"","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"em6oa","text":"\t// 构造方法初始化可用cpu核心数以及ExecutorService","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"d6o08","text":"\tpublic ExportCrontab() {","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"dk8th","text":"\t\tcoreCpuNum = Runtime.getRuntime().availableProcessors();","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"3hkd7","text":"\t\texec = Executors.newFixedThreadPool(coreCpuNum);","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"6jtci","text":"\t}","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"a3h16","text":"","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"eldcl","text":"\tprivate void processExport(List<ExportQueueBean> list) {","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"eg0qn","text":"\t\tfor (int i = 0; i < coreCpuNum; i++) {","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"5ghdm","text":"\t\t\tint increment = list.size() / coreCpuNum + 1;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"frt8j","text":"\t\t\tint start = increment * i;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"8rbai","text":"\t\t\tint end = increment * (i + 1);","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"50h74","text":"\t\t\tif (end > list.size()) {","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"517fn","text":"\t\t\t\tend = list.size();","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"cmakv","text":"\t\t\t}","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"52pm7","text":"\t\t\tExportExcutor exportExcutor = new ExportExcutor(list, start, end);","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"5atlr","text":"\t\t\texec.execute(exportExcutor);","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"8srl9","text":"\t\t}","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"1ngfq","text":"\t}","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"98j4v","text":"","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"csu8","text":"\tclass ExportExcutor implements Runnable {","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"8gf4t","text":"\t\tprivate List<ExportQueueBean> list;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"55g12","text":"\t\tprivate int start;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"f04t4","text":"\t\tprivate int end;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"cv3lv","text":"","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"9peke","text":"\t\t// 构造方法","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"evk1i","text":"\t\tpublic ExportExcutor(List<ExportQueueBean> list, int start, int end) {","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"e6c32","text":"\t\t\tthis.list = list;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"j05q","text":"\t\t\tthis.start = start;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"dujdo","text":"\t\t\tthis.end = end;","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"fajci","text":"\t\t}","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"louq","text":"","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"lli6","text":"\t\t@Override","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"1oq1t","text":"\t\tpublic void run() {","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"66lfq","text":"\t\t\treportService = new ReportService();","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"ba6nu","text":"\t\t\tlog.info(\"获取到的serverIp = \" + serverIp);","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"6vf1u","text":"\t\t\tfor (int i = start; i < end; i++) {","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"1fhru","text":"\t\t\t\tExportQueueBean queue = list.get(i);","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"2vbbr","text":"\t\t\t\tif (\"10.243.31.16\".equals(serverIp)) {","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"8g8q5","text":"\t\t\t\t\tlog.info(\"进入16主机，执行买家卖家报表导出操作...\");","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"c9ge7","text":"\t\t\t\t\tif (StringUtils.isEmpty(queue.getBranchId())) {\t// 16主机 买家和卖家","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"2p9lm","text":"\t\t\t\t\t\treportService.prossDownLoad(queue);","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"8aoic","text":"\t\t\t\t\t}","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"20gvs","text":"\t\t\t\t} else if(\"10.243.31.18\".equals(serverIp)) {","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"79o5n","text":"\t\t\t\t\tlog.info(\"进入18主机，执行管理员报表导出操作...\");","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"elqsk","text":"\t\t\t\t\tif (StringUtils.isNotEmpty(queue.getBranchId())) {// 18主机 管理员","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"3ttm0","text":"\t\t\t\t\t\treportService.prossDownLoad(queue);","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"3plmo","text":"\t\t\t\t\t}","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"7tn9g","text":"\t\t\t\t} else {","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"cj95k","text":"\t\t\t\t\tlog.info(\"进入未知主机，执行买家卖家报表导出操作...\");","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"fprrj","text":"\t\t\t\t\tif (StringUtils.isEmpty(queue.getBranchId())) {","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"atdut","text":"\t\t\t\t\t\treportService.prossDownLoad(queue);","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"4rpiu","text":"\t\t\t\t\t}","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"5b91o","text":"\t\t\t\t}","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"chufm","text":"\t\t\t}","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"5rfgm","text":"\t\t}","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"67e4g","text":"","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"fc25k","text":"\t}","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"2sh6n","text":"\tpublic void close() {","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"biujm","text":"\t\texec.shutdown();","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"852am","text":"\t}","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"1lnks","text":"\tpublic static void main(String[] args) {","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"9ggh6","text":"\t\tlong start = System.currentTimeMillis();","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"9js80","text":"\t\tlog.info(\"导出报表队列下载任务开始!\");","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"dqvjs","text":"\t\tReportService reportService = new ReportService();","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"cgq6c","text":"\t\tExportQueueBean dto = new ExportQueueBean();","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"ca7ul","text":"\t\tdto.setStatus(\"0\");","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"avf2v","text":"\t\tList<ExportQueueBean> list = reportService.getByProper(dto);","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"aaiod","text":"\t\tif (list != null) {","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"ah361","text":"\t\t\tExportCrontab crontab = new ExportCrontab();","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"f97rd","text":"\t\t\tcrontab.processExport(list);","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"epfvi","text":"\t\t\tcrontab.close();","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"5sjds","text":"\t\t} else {","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"6tth5","text":"\t\t\tlog.info(\"导出报表队列下载数目:0\");","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"79n4q","text":"\t\t}","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"9be5r","text":"\t\tlong end = System.currentTimeMillis();","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"67sh7","text":"\t\tlog.info(\"导出报表队列下载任务结束.花费时间\" + (end - start) + \"ms\");","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"57vl2","text":"\t}","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"4socu","text":"}","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"c7n6b","text":"","type":"custom-code-block-java","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}},{"key":"59kd9","text":"","type":"unstyled","depth":0,"inlineStyleRanges":[],"entityRanges":[],"data":{}}]},"dateCreated":"2017-12-18T07:06:22.922Z","lastUpdated":"2017-12-18T07:11:46.854Z","notebookId":"Hk19G3VMz"}
